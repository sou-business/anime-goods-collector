FROM node:22-alpine

# 作業ディレクトリ設定（ワークスペースのルート）
WORKDIR /app

# ルートの package.json と package-lock.json をコピー
COPY package*.json ./

# 各パッケージディレクトリもコピー（ローカル依存を解決するため）
COPY app_common ./app_common
COPY app_batch ./app_batch

# 依存関係インストール&ビルド
RUN npm ci

# ヘルスチェック（オプション）
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
  CMD node -e "console.log('Batch service is running')" || exit 1

# バッチアプリケーション起動
WORKDIR /app/app_batch
CMD ["npm", "run", "dev"]
