# Node.js 20 Debian ベース
FROM node:20-bullseye

# 作業ディレクトリ設定
WORKDIR /app

# ルートの package.json と package-lock.json をコピー
COPY package*.json ./

# 各パッケージディレクトリをコピー
COPY app_common ./app_common
COPY app_web ./app_web

# 依存関係インストール&ビルド
RUN npm ci

# lightningcss を Docker 環境用に再ビルド（ネイティブモジュールのため）
WORKDIR /app/app_web
RUN npm rebuild lightningcss

# 作業ディレクトリ作成と権限付与
RUN mkdir -p /app/.next/cache/images \
    && chown -R node:node /app/.next

# ヘルスチェック
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
  CMD wget -qO- http://localhost:3000/health || exit 1

# Webアプリケーション起動
WORKDIR /app/app_web
CMD ["npm", "start"]